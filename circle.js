// Posrec game 
// 02-2018 Bart Pelssers

var positions = [{"x": -12.345668451390225, "y": 46.074661913988564}, {"x": -4.157328929063286, "y": 47.518487098976266}, {"x": 4.1573289290632935, "y": 47.51848709897626}, {"x": 12.345668451390232, "y": 46.07466191398856}, {"x": 20.158891085031385, "y": 43.230881441648194}, {"x": 27.35959601394491, "y": 39.073552512584904}, {"x": 33.72899346259835, "y": 33.72899346259829}, {"x": 39.073552512584904, "y": 27.359596013944902}, {"x": 43.23088144164822, "y": 20.158891085031343}, {"x": 46.074661913988564, "y": 12.345668451390226}, {"x": 47.518487098976266, "y": 4.157328929063288}, {"x": 47.51848709897626, "y": -4.157328929063292}, {"x": 46.07466191398855, "y": -12.34566845139027}, {"x": 43.230881441648194, "y": -20.158891085031378}, {"x": 39.07355251258489, "y": -27.359596013944923}, {"x": 33.72899346259832, "y": -33.72899346259832}, {"x": 27.35959601394489, "y": -39.07355251258491}, {"x": 20.158891085031346, "y": -43.23088144164822}, {"x": 12.34566845139023, "y": -46.074661913988564}, {"x": 4.157328929063292, "y": -47.518487098976266}, {"x": -4.1573289290633095, "y": -47.51848709897626}, {"x": -12.345668451390264, "y": -46.07466191398856}, {"x": -20.158891085031378, "y": -43.230881441648194}, {"x": -27.359596013944902, "y": -39.07355251258491}, {"x": -33.728993462598325, "y": -33.728993462598304}, {"x": -39.07355251258492, "y": -27.359596013944888}, {"x": -43.23088144164821, "y": -20.158891085031357}, {"x": -46.074661913988564, "y": -12.345668451390232}, {"x": -47.518487098976266, "y": -4.157328929063286}, {"x": -47.51848709897626, "y": 4.157328929063306}, {"x": -46.07466191398856, "y": 12.345668451390251}, {"x": -43.2308814416482, "y": 20.15889108503137}, {"x": -39.073552512584904, "y": 27.359596013944902}, {"x": -33.72899346259831, "y": 33.72899346259832}, {"x": -27.359596013944895, "y": 39.07355251258491}, {"x": -20.158891085031357, "y": 43.23088144164821}, {"x": -10.288057042825152, "y": 38.39555159499048}, {"x": -2.0803542606570264, "y": 39.69552400649432}, {"x": 6.218269985349179, "y": 39.260611538656725}, {"x": 14.245125994425699, "y": 37.10982195326377}, {"x": 21.64940164184732, "y": 33.33715507583061}, {"x": 28.107494552165267, "y": 28.107494552165264}, {"x": 33.33715507583061, "y": 21.649401641847316}, {"x": 37.10982195326378, "y": 14.245125994425663}, {"x": 39.26061153865673, "y": 6.218269985349142}, {"x": 39.6955240064943, "y": -2.080354260657028}, {"x": 38.39555159499045, "y": -10.288057042825226}, {"x": 35.41750933648761, "y": -18.046122364647005}, {"x": 30.891551967914587, "y": -25.01548554423105}, {"x": 25.015485544231034, "y": -30.8915519679146}, {"x": 18.04612236464697, "y": -35.41750933648763}, {"x": 10.288057042825173, "y": -38.39555159499047}, {"x": 2.080354260657014, "y": -39.69552400649432}, {"x": -6.218269985349176, "y": -39.260611538656725}, {"x": -14.245125994425695, "y": -37.10982195326377}, {"x": -21.64940164184734, "y": -33.337155075830594}, {"x": -28.10749455216527, "y": -28.107494552165253}, {"x": -33.33715507583061, "y": -21.64940164184732}, {"x": -37.109821953263776, "y": -14.245125994425678}, {"x": -39.260611538656725, "y": -6.218269985349172}, {"x": -39.6955240064943, "y": 2.080354260657023}, {"x": -38.395551594990465, "y": 10.288057042825208}, {"x": -35.41750933648762, "y": 18.04612236464699}, {"x": -30.891551967914587, "y": 25.01548554423104}, {"x": -25.015485544231034, "y": 30.8915519679146}, {"x": -18.04612236464698, "y": 35.41750933648763}, {"x": -8.23044563426015, "y": 30.716441275992377}, {"x": 3.108624468950438e-14, "y": 31.8}, {"x": 8.230445634260182, "y": 30.716441275992366}, {"x": 15.90000000000001, "y": 27.53960784034514}, {"x": 22.485995641732213, "y": 22.485995641732213}, {"x": 27.53960784034516, "y": 15.899999999999984}, {"x": 30.716441275992374, "y": 8.230445634260152}, {"x": 31.8, "y": 0.0}, {"x": 30.716441275992366, "y": -8.230445634260182}, {"x": 27.539607840345138, "y": -15.90000000000002}, {"x": 22.485995641732202, "y": -22.485995641732224}, {"x": 15.899999999999999, "y": -27.539607840345152}, {"x": 8.230445634260153, "y": -30.716441275992374}, {"x": -1.3322676295501878e-14, "y": -31.8}, {"x": -8.230445634260162, "y": -30.716441275992374}, {"x": -15.900000000000006, "y": -27.539607840345145}, {"x": -22.485995641732217, "y": -22.485995641732202}, {"x": -27.539607840345152, "y": -15.899999999999993}, {"x": -30.716441275992374, "y": -8.230445634260155}, {"x": -31.8, "y": 3.552713678800501e-15}, {"x": -30.71644127599237, "y": 8.230445634260168}, {"x": -27.539607840345145, "y": 15.900000000000006}, {"x": -22.48599564173221, "y": 22.485995641732217}, {"x": -15.899999999999997, "y": 27.539607840345152}, {"x": -6.172834225695112, "y": 23.037330956994282}, {"x": 2.0786644645316468, "y": 23.75924354948813}, {"x": 10.079445542515693, "y": 21.615440720824097}, {"x": 16.864496731299177, "y": 16.864496731299145}, {"x": 21.61544072082411, "y": 10.079445542515671}, {"x": 23.759243549488133, "y": 2.078664464531644}, {"x": 23.037330956994275, "y": -6.172834225695135}, {"x": 19.536776256292445, "y": -13.679798006972462}, {"x": 13.679798006972446, "y": -19.536776256292455}, {"x": 6.172834225695115, "y": -23.037330956994282}, {"x": -2.0786644645316548, "y": -23.75924354948813}, {"x": -10.079445542515689, "y": -21.615440720824097}, {"x": -16.864496731299162, "y": -16.864496731299152}, {"x": -21.615440720824104, "y": -10.079445542515678}, {"x": -23.759243549488133, "y": -2.078664464531643}, {"x": -23.03733095699428, "y": 6.172834225695126}, {"x": -19.536776256292452, "y": 13.679798006972451}, {"x": -13.679798006972447, "y": 19.536776256292455}, {"x": -4.115222817130075, "y": 15.358220637996189}, {"x": 4.115222817130091, "y": 15.358220637996183}, {"x": 11.242997820866107, "y": 11.242997820866107}, {"x": 15.358220637996187, "y": 4.115222817130076}, {"x": 15.358220637996183, "y": -4.115222817130091}, {"x": 11.242997820866101, "y": -11.242997820866112}, {"x": 4.115222817130077, "y": -15.358220637996187}, {"x": -4.115222817130081, "y": -15.358220637996187}, {"x": -11.242997820866108, "y": -11.242997820866101}, {"x": -15.358220637996187, "y": -4.1152228171300775}, {"x": -15.358220637996185, "y": 4.115222817130084}, {"x": -11.242997820866105, "y": 11.242997820866108}, {"x": -2.0576114085650374, "y": 7.679110318998094}, {"x": 5.621498910433053, "y": 5.621498910433053}, {"x": 7.679110318998092, "y": -2.0576114085650454}, {"x": 2.0576114085650383, "y": -7.679110318998093}, {"x": -5.621498910433054, "y": -5.621498910433051}, {"x": -7.6791103189980925, "y": 2.057611408565042}, {"x": 0.0, "y": 0.0}];

var live = [1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1];

var width = 500,
    max_r = 55;

var x_axis = d3.scaleLinear().range([0, width]).domain([-max_r, max_r]),
    y_axis = d3.scaleLinear().range([width, 0]).domain([-max_r, max_r]);

var svg = d3.select("#pmts");

var pos_info = d3.select("#info").append("div");
var results = d3.select("#results").append("div");

var event_count = 0;
var mouse = [0, 0];

function setEvent(i) {
    var pat = game_data[i]['pattern'];
    var norm = d3.scaleLog().domain([0.5, d3.max(pat)]).range([0, 1]);
    d3.selectAll("circle")
        .data(pat)
        .style("fill", function(d, i) {
            return live[i] ? d3.interpolateViridis(norm(d)) : "black";
        });
}

function scoreEvent(i, mouse) {
    var truth = game_data[i]['truth'];
    var distance = game_data[i]['distance'];
    distance['you'] = Math.sqrt(Math.pow((truth['x'] - toPos(mouse[0])), 2) +
                                Math.pow((truth['y'] + toPos(mouse[1])), 2));
    return distance;
}

var scores = {'mp' : 0, 'ws': 0, 'rwm': 0, 'nn': 0, 'tpf': 0, 'you': 0};
var score_count = 0;

function setResult(distance) {
    results.remove();
    results = d3.select("#results").append("div");
    score_count++;
    if (score_count == 1)
        results.append("div").html("<h4>Mean error after " + score_count + " try:</h4>");
    else
        results.append("div").html("<h4>Mean error after " + score_count + " tries:</h4>");
    sorted_scores = [];
    for (key in distance) {
        scores[key] += distance[key];
        sorted_scores.push([key, scores[key]]);
    }
    sorted_scores.sort(function(a, b) {return a[1] - b[1];});
    for (score in sorted_scores) {
        s = sorted_scores[score];
        if (s[0] == "you") {
            results.append("div")
                .attr("id", "me")
                .html((parseInt(score) + 1) + ") " + s[0] + ": " + (s[1] / score_count).toFixed(2) + " cm.");
        } else {
            results.append("div")
                .html((parseInt(score) + 1) + ") " + s[0].toUpperCase() + ": " + (s[1] / score_count).toFixed(2) + " cm.");
        }
    }
}

function toPos(p) {
    return (p - (width/2)) * max_r / (width/2);
}

svg.selectAll("circle")
    .data(positions)
    .enter().append("circle")
        .attr("cx", function(d) { return x_axis(d['x']);})
        .attr("cy", function(d) { return y_axis(d['y']);})
        .attr("r", 16)
        .style("fill", function(d, i) { return live[i] ? 'steelblue' : 'black';});

svg.on('mousemove', function() {
    mouse = d3.mouse(this);
    pos_info.html("<p>Position: x=" + toPos(mouse[0]).toFixed(2) + " cm, y=" + -toPos(mouse[1]).toFixed(2) + " cm.</p>");
});
svg.on('mouseleave', function() {
    pos_info.html("");
});
svg.on('click', function() {
    if (event_count == 0) {  // first click, start
        setEvent(event_count);
    } else if (event_count > 99) {  // last, loop back
        event_count = 0;
        setEvent(event_count);
    } else {
        // score prev event
        setResult(scoreEvent(event_count-1, d3.mouse(this)));
        // set new event
        setEvent(event_count);
    }
    event_count++;
});
